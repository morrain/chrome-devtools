## 使用谷歌开发者工具进行代码调试

如下教程介绍了使用谷歌开发者工具调试JavaScript的基本步骤。虽然教程以一个特定问题的例子进行讲解，但基本的调试方法对所有JavaScript问题都适用。如果你还在用`console.log()`来调试并修复你代码中的问题，那么你可以考虑使用如下教程中介绍的方法，你会发现它更高效，定位问题更快。

### 第一步：重现问题

重现问题一般是解决问题的第一步。“重现问题”就是说找到通过一系列的操作使问题重复出现的方法。您可能需要重现多次，尽可能地排除任何不必要的步骤。

按照以下说明重现本教程中需要修复的问题：

1. 打开[**Demo**](https://googlechrome.github.io/devtools-samples/debug-js/get-started).  Demo会在一个新窗口中打开.
2. 在**数字1**输入框中输入5.
3. 在**数字2**输入框中输入1.
4. 点击**“数字1，数字2求和”**.
5. 会看到结果显示`5 + 1 = 51`.

显而易见，结果是不对的，正确的结果应该是6.那么接下来，我们来查找哪里出了问题。

### 第二步：使用断点

谷歌开发者工具可以让JavaScript代码在执行过程中，暂停下来，进而查看当时所有变量的值。我们把中断代码执行的标记称为**断点**。赶紧试一下吧：

1. 在Demo页面[打开谷歌开发者工具](配置开发者工具.md)
2. 切换到**Sources**面板

    1. 点击**Event Listener Breakpoints**展开**事件断点**窗口。该窗口列举了一系列可以展开的事件类别，如**Animation**、**Clipboard**等等。
    2. 在**Mouse**事件左侧，有一个展开的小箭头![](https://developers.google.cn/web/tools/chrome-devtools/images/expand.png). 点击展开，会看到一系列可以勾选的鼠标事件，如`click`,`dblclick`等等
    3. 勾选**`click`**事件
    
    ![](https://developers.google.cn/web/tools/chrome-devtools/javascript/imgs/get-started-click-breakpoint.png)
    
     > 如图所示 鼠标点击的事件断点被开启。当窗口足够大时 **Event Listener Breakpoints** 会显示在右侧，而不像本例中显示在下方。
     
3. 返回到Demo页面，点击**“数字1，数字2求和”**摁钮，程序会中断执行，**Sources**面板会有一行代码高亮显示，本例中高亮显示的为：

   `function onClick() {`
   
当勾选了**click**事件后，便开启了鼠标点击的事件断点。在浏览器内任意注册过点击事件的节点上单击，谷歌开发者工具自动中断在点击事件处理函数的第一行。

> 点击事件只是众多事件中的一种，实际使用什么事件断点取决于你要解决什么问题，要根据实际情况，不可同一而论。

### 第三步：逐步执行

通常造成问题的原因是脚本执行的顺序不对。通过逐步执行可以跟踪你的代码执行的每一步，一行代码一行代码执行，找到哪里执行的不对，不是你本来想要的预期。赶紧来试一下吧：

1. 在**Sources**面板，点击**跳转到函数内执行**摁钮(![](https://developers.google.cn/web/tools/chrome-devtools/images/step-into.png))，代码将进入到`onClick`函数内部执行，此时，谷歌开发者高亮如下一行代码：

  `if (inputsAreEmpty()) {`
  
2. 点击**跳过函数执行**摁钮（![](https://developers.google.cn/web/tools/chrome-devtools/images/step-over.png)）.谷歌开发者工具直接执行完`inputsAreEmpty()`函数，并不会跳到函数内部执行。注意谷歌开发者工具会跳过几行代码，因为`inputsAreEmpty()`值为false,所以`if`语句块中的代码不会被执行。

如上所述是逐步跟踪代码的基本方法.如果你看过`get-started.js`的代码，你会发现问题可能出在`updateLabel()`函数的某个地方。此时，你可不用从头开始逐步执行，你可以通过更快捷的途径把断点设置在离问题最近的地方。

### 第四步：设置代码行断点

代码行断点是断点中最常用的，你可以指定你想要中断的代码行。

1. 找到`updateLabel()`函数中的最后一行代码：

  `label.textContent = addend1 + ' + ' + addend2 + ' = ' + sum;`
2. 在代码左侧，可以看到代码行号，本例中为**32**。点击行号，便会在该行设置代码行断点，此时有一个蓝色的箭头标识(![](http://p1.bpimg.com/582863/5fb230d1dcd6cc16.png))。设置代码行断点后，每次执行到此行时，都会中断执行。
3. 点击**恢复脚本运行**摁钮(![](https://developers.google.cn/web/tools/chrome-devtools/images/resume-script-execution.png))，代码会恢复执行，只到遇到断点才会中断执行。
4. 返回到Demo页面，点击**“数字1，数字2求和”**摁钮，代码中断到`updateLabel()`最后一行，此时谷歌开发者工具会显示出`addend1`,`addend2`和`sum`的值。

  ![](http://p1.bqimg.com/582863/5e6258159844fd18.png)
  
`sum`的值看上去是有异常的，它应该是数字，而脚本却把它当成字符串处理了。这也许就是问题所在。

### 第五步：检查变量的值

另外一个导致问题的原因通常是变量或者函数产生了一个预期以外的值。很多开发者会使用`console.log()`来跟踪变量如何变化，但是用它来跟踪变量的值并不方便，一来你需要修改你的源代码，二来大多情况下你并知道哪个变量有问题，需要打印众多变量的值。

现在可使用谷歌开发者工具的**Watch Expressions**窗口，取代`console.log()`来实时监视变量的值。就跟它的名字一样，**监视表达式**并不仅限于监视变量的值，你可以输入任何有效的表达式。

1. 打开**Sources**面板，点击**Watch**窗口选项卡
2. 点击**Add Expression**摁钮(![](https://developers.google.cn/web/tools/chrome-devtools/javascript/imgs/add-expression.png))
3. 输入`typeof sum`
4. 然后按回车键，谷歌开发者工具便会显示`typeof sum: "string"`。冒号后面是要监视的表达式的值

  ![](http://i1.piimg.com/582863/6f7a87751083a8d2.png)
  
正中我们怀疑的那样，sum的值被当成字符进行运算了，而实际上它应该是当成数字进行运算的。

另一个取代`console.log()`的方案是使用**抽屉式控制台**。控制台可以输入任意的脚本表达式。开发者通常在调试阶段使用控制台改写变量的值。此例中，还可以使用控制台来测试修复后的代码是否正确。

1. 通过**ESC**键，打开**抽屉式控制台** 
2. 在控制台中输入`parseInt(addend1) + parseInt(addend2)`
3. 回车。谷歌开发者工具打印输出表达式的结果6，这正是我们希望demo计算出来的结果。

   ![](http://i1.piimg.com/582863/a31d45053cf2ee4c.png)
   
#### 监视变量

上面我们介绍了检查变量的值，下面我详细介绍一下**Watch Expressions**窗口的用法。利用好开发者工具的这个功能，可以省去经常在控制台输入的麻烦，很好的提高调试效率。如何添加表达式，我们上面提过到，通过点击绿色框中的小加号，会出现输入框，输入完表达式后，回车键保存，即可添加到监视列表中。

![](https://developers.google.cn/web/tools/chrome-devtools/javascript/imgs/add-variable-to-watch.png)

添加后，该变量或者表达工会一直存在于列表中，当该变量不在当前作用域时或者输入的变量不存在时，列表中该项会显示`<not available>`。如下图所示：

![](https://developers.google.cn/web/tools/chrome-devtools/javascript/imgs/undefined-variable-in-watch.png)


### 第六步：修复问题

现在已经找到了问题所在，剩下的就是修改代码，重新运行。谷歌开发者工具支持实时修改：

1. 在**Sources**找到需要修改的代码行。将之前的`var sum = addend1 + addend2`替换成`var sum = parseInt(addend1) + parseInt(addend2)`。
2. 保存修改（*Command+S (Mac) or Control+S (Windows, Linux)*）。保存后，整个文件的背景会变红同时文件名会显示*号，表示文件被修改过。
3. 点击**Deactivate breakpoints**摁钮(![](https://developers.google.cn/web/tools/chrome-devtools/images/deactivate-breakpoints-button.png))。它会变蓝色表示该功能被开启，开启该功能后，谷歌开发者工具会忽略所有设置的断点。
4. 点击**Resume script execution**摁钮（![](https://developers.google.cn/web/tools/chrome-devtools/images/resume-script-execution.png)）恢复脚本执行。
5. 测试Demo运算的值，现在计算的值已经正确无误了。

  ![](http://i1.piimg.com/582863/33fc2b079302161b.png)
 > 提示：改动只在浏览器当前页面生效，并没有改动服务器上的源码。如果需要刷新后结果也正确，请修复服务器上的源代码。
 
### 总结

恭喜你现在已经知道了调试JavaScript脚本的基本方法，本节只介绍了两种设置断点的方法，其实还有很多：
 
* **条件断点**
* **异常断点**
* **XHR断点** 

更多断点说明请参考下节[设置断点](设置断点.md) 

更多逐步执行的说明请参考下下节[逐步执行](逐步执行.md)